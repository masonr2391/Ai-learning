<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Optimized AI Game with Replay</title>
<style>
  canvas { background: #eee; display: block; margin: 0 auto; }
  #ui { text-align: center; margin-top: 10px; font-family: sans-serif; }
</style>
</head>
<body>

<canvas id="gameCanvas" width="400" height="400"></canvas>

<div id="ui">
  <div>Attempts: <span id="attempts">0</span></div>
  <div>Average last 10: <span id="avg10">0</span></div>
  <div>Leaderboard (fastest 5): <span id="leaderboard">-</span></div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const gridSize = 20;
const rows = canvas.height / gridSize;
const cols = canvas.width / gridSize;

let attempts = 0;
let last10 = [];
let leaderboard = [];
const maxLeaderboard = 5;

let qTable = {};
const actions = ['up', 'down', 'left', 'right'];

let alpha = 0.5;  // starting learning rate
const alphaDecay = 0.999;
const minAlpha = 0.1;
const gamma = 0.9;  // discount factor

let epsilon = 1.0;
const epsilonDecay = 0.995;
const minEpsilon = 0.05;

const replayBuffer = [];
const maxBuffer = 200;

let player = {x:0, y:0};
let goal = {x:0, y:0};
let steps = 0;

function resetGame() {
  player = {x: Math.floor(Math.random()*cols), y: Math.floor(Math.random()*rows)};
  goal = {x: Math.floor(Math.random()*cols), y: Math.floor(Math.random()*rows)};
  steps = 0;
}

function drawGame() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = 'blue';
  ctx.fillRect(player.x*gridSize, player.y*gridSize, gridSize, gridSize);
  ctx.fillStyle = 'green';
  ctx.fillRect(goal.x*gridSize, goal.y*gridSize, gridSize, gridSize);
}

function getState() {
  let dx = goal.x - player.x;
  let dy = goal.y - player.y;
  return `${dx},${dy}`;
}

function chooseAction(state) {
  if(Math.random() < epsilon || !(state in qTable)) {
    return actions[Math.floor(Math.random()*actions.length)];
  } else {
    let qVals = qTable[state];
    let maxQ = Math.max(...qVals);
    let bestActions = [];
    for(let i=0;i<qVals.length;i++) if(qVals[i]===maxQ) bestActions.push(actions[i]);
    return bestActions[Math.floor(Math.random()*bestActions.length)];
  }
}

function doAction(action) {
  if(action==='up' && player.y>0) player.y--;
  if(action==='down' && player.y<rows-1) player.y++;
  if(action==='left' && player.x>0) player.x--;
  if(action==='right' && player.x<cols-1) player.x++;
}

function computeReward(prev, curr) {
  let prevDist = Math.abs(prev.x - goal.x) + Math.abs(prev.y - goal.y);
  let currDist = Math.abs(curr.x - goal.x) + Math.abs(curr.y - goal.y);
  if(curr.x===goal.x && curr.y===goal.y) return 10;
  return prevDist - currDist;
}

function updateQ(prevState, action, reward, nextState) {
  if(!(prevState in qTable)) qTable[prevState] = [0,0,0,0];
  if(!(nextState in qTable)) qTable[nextState] = [0,0,0,0];
  let idx = actions.indexOf(action);
  let maxNext = Math.max(...qTable[nextState]);
  qTable[prevState][idx] += alpha*(reward + gamma*maxNext - qTable[prevState][idx]);
}

function replayExperience() {
  // Update Q-table from random samples in buffer
  for(let i=0;i<Math.min(20,replayBuffer.length);i++){
    let idx = Math.floor(Math.random()*replayBuffer.length);
    let exp = replayBuffer[idx];
    updateQ(exp.state, exp.action, exp.reward, exp.nextState);
  }
}

function aiStep() {
  let state = getState();
  let action = chooseAction(state);
  let prevPos = {...player};
  doAction(action);
  steps++;

  let reward = computeReward(prevPos, player);
  let nextState = getState();
  updateQ(state, action, reward, nextState);

  // Save experience for replay
  replayBuffer.push({state, action, reward, nextState});
  if(replayBuffer.length>maxBuffer) replayBuffer.shift();

  replayExperience();
  drawGame();

  if(player.x===goal.x && player.y===goal.y) {
    finishEpisode();
  } else {
    requestAnimationFrame(aiStep);
  }
}

function finishEpisode() {
  attempts++;
  document.getElementById('attempts').textContent = attempts;

  last10.push(steps);
  if(last10.length>10) last10.shift();
  let avg = last10.reduce((a,b)=>a+b,0)/last10.length;
  document.getElementById('avg10').textContent = avg.toFixed(2);

  leaderboard.push(steps);
  leaderboard.sort((a,b)=>a-b);
  if(leaderboard.length>maxLeaderboard) leaderboard.pop();
  document.getElementById('leaderboard').textContent = leaderboard.join(', ');

  epsilon = Math.max(minEpsilon, epsilon*epsilonDecay);
  alpha = Math.max(minAlpha, alpha*alphaDecay);

  setTimeout(resetGame, 100);
  setTimeout(aiStep, 100);
}

// Start
resetGame();
drawGame();
setTimeout(aiStep, 100);
</script>
</body>
</html>

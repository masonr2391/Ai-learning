<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Learning Game</title>
<style>
  canvas { border:1px solid black; background:#eee; display:block; margin: 20px auto; }
  #ui { text-align:center; font-family:sans-serif; }
  #leaderboard { margin-top:10px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
</head>
<body>
<div id="ui">
  <div>Attempts: <span id="attempts">0</span></div>
  <div>Timer: <span id="timer">0</span></div>
  <div>Avg last 10: <span id="avg10">0</span></div>
  <div id="leaderboard"><b>Leaderboard (fastest steps):</b><br></div>
</div>
<canvas id="game" width="400" height="400"></canvas>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

const gridSize = 20;
const cols = canvas.width / gridSize;
const rows = canvas.height / gridSize;

let attempts = 0;
let last10 = [];
let leaderboard = [];

const goal = {x: Math.floor(Math.random()*cols), y: Math.floor(Math.random()*rows)};
let agent = {x:0, y:0};

document.getElementById('leaderboard').innerHTML = `<b>Leaderboard (fastest steps):</b><br>`;
document.getElementById('attempts').innerText = attempts;

let timer = 0;
let interval;

// Deep Q-Network approximation
const stateSize = 4; // agent x,y and goal x,y
const actionSize = 4; // up, down, left, right
let gamma = 0.95;
let epsilon = 1.0;
let epsilonMin = 0.01;
let epsilonDecay = 0.995;

const model = tf.sequential();
model.add(tf.layers.dense({units: 24, inputShape:[stateSize], activation:'relu'}));
model.add(tf.layers.dense({units:24, activation:'relu'}));
model.add(tf.layers.dense({units:actionSize, activation:'linear'}));
model.compile({optimizer: tf.train.adam(0.001), loss: 'meanSquaredError'});

// Helper functions
function resetGame() {
    agent = {x:0, y:0};
    goal.x = Math.floor(Math.random()*cols);
    goal.y = Math.floor(Math.random()*rows);
    timer = 0;
    clearInterval(interval);
    interval = setInterval(()=>{timer++; document.getElementById('timer').innerText = timer;},100);
}

function drawGame() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // Goal
    ctx.fillStyle='green';
    ctx.fillRect(goal.x*gridSize, goal.y*gridSize, gridSize, gridSize);
    // Agent
    ctx.fillStyle='blue';
    ctx.fillRect(agent.x*gridSize, agent.y*gridSize, gridSize, gridSize);
}

function getState() {
    return [agent.x/cols, agent.y/rows, goal.x/cols, goal.y/rows];
}

function chooseAction(state) {
    if(Math.random() < epsilon){
        return Math.floor(Math.random()*actionSize);
    } else {
        return tf.tidy(() => {
            const input = tf.tensor2d([state]);
            const pred = model.predict(input);
            return pred.argMax(1).dataSync()[0];
        });
    }
}

function move(action){
    if(action==0 && agent.y>0) agent.y--;
    if(action==1 && agent.y<rows-1) agent.y++;
    if(action==2 && agent.x>0) agent.x--;
    if(action==3 && agent.x<cols-1) agent.x++;
}

async function trainStep(state, action, reward, nextState, done){
    const target = tf.tidy(() => {
        const target = model.predict(tf.tensor2d([state])).arraySync()[0];
        let qUpdate = reward;
        if(!done){
            const nextQ = model.predict(tf.tensor2d([nextState])).max(1).dataSync()[0];
            qUpdate = reward + gamma*nextQ;
        }
        target[action] = qUpdate;
        return tf.tensor2d([target]);
    });
    await model.fit(tf.tensor2d([state]), target, {epochs:1, verbose:0});
    target.dispose();
}

async function runEpisode(){
    resetGame();
    let done=false;
    let steps=0;
    while(!done && steps<1000){
        drawGame();
        const state = getState();
        const action = chooseAction(state);
        move(action);
        const nextState = getState();
        let reward = (agent.x==goal.x && agent.y==goal.y)?100:-1;
        done = (agent.x==goal.x && agent.y==goal.y);
        await trainStep(state, action, reward, nextState, done);
        steps++;
    }
    attempts++;
    last10.push(steps);
    if(last10.length>10) last10.shift();
    document.getElementById('attempts').innerText = attempts;
    const avg = Math.round(last10.reduce((a,b)=>a+b,0)/last10.length);
    document.getElementById('avg10').innerText = avg;

    leaderboard.push(steps);
    leaderboard.sort((a,b)=>a-b);
    if(leaderboard.length>5) leaderboard.pop();
    document.getElementById('leaderboard').innerHTML = `<b>Leaderboard (fastest steps):</b><br>`+leaderboard.join('<br>');

    if(epsilon>epsilonMin) epsilon*=epsilonDecay;

    setTimeout(runEpisode, 100); // Next episode
}

// Start
runEpisode();
</script>
</body>
</html>
